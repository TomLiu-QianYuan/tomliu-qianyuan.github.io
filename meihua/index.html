<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹¾å…ƒ Â· æ˜“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #d4af37;
            --red: #ef4444;
            --bg: #050505;
            --text-main: #d1d5db;
        }

        /* äº”è¡Œé…è‰² */
        .color-jin { background-color: #d4af37 !important; box-shadow: 0 0 8px rgba(212, 175, 55, 0.3); }
        .color-mu  { background-color: #4ade80 !important; box-shadow: 0 0 8px rgba(74, 222, 128, 0.3); }
        .color-shui{ background-color: #60a5fa !important; box-shadow: 0 0 8px rgba(96, 165, 250, 0.3); }
        .color-huo { background-color: #f87171 !important; box-shadow: 0 0 8px rgba(248, 113, 113, 0.3); }
        .color-tu  { background-color: #d97706 !important; box-shadow: 0 0 8px rgba(217, 119, 6, 0.3); }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg);
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .input-void {
            background: transparent;
            border: none;
            border-bottom: 1px solid #333;
            color: #fff;
            text-align: center;
            outline: none;
            transition: all 0.6s ease;
            font-family: inherit;
            border-radius: 0;
        }
        .input-void:focus { border-bottom-color: var(--gold); }
        .input-void::placeholder { color: #333; font-weight: 200; }

        /* ç»“æœé¡µçš„å¯ç¼–è¾‘é—®é¢˜è¾“å…¥æ¡† */
        .input-edit {
            background: transparent;
            border: 1px dashed transparent;
            color: #d1d5db;
            text-align: center;
            outline: none;
            width: 100%;
            font-family: 'Noto Serif SC', serif;
            font-style: italic;
        }
        .input-edit:hover, .input-edit:focus {
            border-bottom-color: #333;
        }

        /* åé¦ˆæ–‡æœ¬åŸŸ */
        .textarea-feedback {
            background: #0f0f0f;
            border: 1px solid #222;
            color: #888;
            font-size: 0.75rem;
            line-height: 1.5;
            width: 100%;
            resize: none;
            outline: none;
            transition: border-color 0.3s;
        }
        .textarea-feedback:focus { border-color: var(--gold); color: #ccc; }

        .btn-spirit {
            border: 1px solid #333;
            color: #666;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            background: transparent;
        }
        .btn-spirit:hover, .btn-spirit:active {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .gua-col { display: flex; flex-direction: column; align-items: center; margin: 0 8px; position: relative; }
        .gua-grid { display: flex; flex-direction: column; width: 60px; gap: 6px; }
        @media (min-width: 768px) { .gua-col { margin: 0 16px; } .gua-grid { width: 72px; gap: 8px; } }

        .gua-row { height: 8px; display: flex; justify-content: space-between; position: relative; width: 100%; }
        @media (min-width: 768px) { .gua-row { height: 10px; } }

        .bar {
            background-color: var(--gold);
            height: 100%;
            border-radius: 1px;
            opacity: 0.95;
            transition: background-color 0.5s ease;
        }
        .yang-line .bar { width: 100%; }
        .yin-line .bar { width: 42%; }

        .moving-dot {
            position: absolute; right: -20px; top: 50%; transform: translateY(-50%);
            width: 5px; height: 5px; background-color: var(--red);
            border-radius: 50%; box-shadow: 0 0 8px var(--red);
        }

        .fade-in-up { animation: fadeInUp 1s ease forwards; opacity: 0; transform: translateY(20px); }
        .fade-out { animation: fadeOut 0.8s ease forwards; pointer-events: none; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.95); } }

        .mark-good { color: #a7f3d0; text-shadow: 0 0 5px rgba(167, 243, 208, 0.1); }
        .mark-bad { color: #fca5a5; text-shadow: 0 0 5px rgba(252, 165, 165, 0.1); }
        .mark-gold { color: var(--gold); }

        .modal-content {
            width: 90%; max-width: 30rem;
            background-color: #0a0a0a; border: 1px solid #222;
            border-radius: 0.75rem; padding: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- é¡¶éƒ¨ LOGO -->
    <header id="main-header" class="fixed top-8 left-0 right-0 text-center z-50 transition-all duration-700">
        <h1 class="text-2xl font-light tracking-[0.8em] text-[#d4af37] opacity-80 cursor-pointer" onclick="resetApp()">ä¹¾ å…ƒ</h1>
    </header>

    <!-- ä¸»å®¹å™¨ -->
    <main class="w-full max-w-6xl relative flex items-center justify-center min-h-[600px]">

        <!-- åœºæ™¯1ï¼šè¾“å…¥ç•Œé¢ -->
        <div id="scene-input" class="w-full max-w-lg text-center transition-all duration-700 space-y-10 md:space-y-12">
            <div class="space-y-2 opacity-60 mt-12 md:mt-0">
                <p class="text-xs tracking-[0.2em] font-light">ä¸€ç‰©ä»æ¥æœ‰ä¸€èº«</p>
                <p class="text-xs tracking-[0.2em] font-light">ä¸€èº«è¿˜æœ‰ä¸€ä¹¾å¤</p>
            </div>

            <div class="flex justify-center space-x-6 md:space-x-8 text-xs text-gray-500">
                <button onclick="setMode('time')" id="btn-mode-time" class="hover:text-[#d4af37] transition-colors text-[#d4af37] p-2">æ—¶é—´èµ·å¦</button>
                <button onclick="setMode('number')" id="btn-mode-number" class="hover:text-[#d4af37] transition-colors p-2">æŠ¥æ•°èµ·å¦</button>
                <button onclick="setMode('random')" id="btn-mode-random" class="hover:text-[#d4af37] transition-colors p-2">å¿ƒåŠ¨å æµ‹</button>
            </div>

            <div class="h-20 flex items-center justify-center">
                <div id="input-group-time" class="w-full px-4">
                    <input type="datetime-local" id="inp-time" class="input-void w-full md:w-64 text-sm text-gray-400 font-light">
                </div>
                <div id="input-group-number" class="hidden flex space-x-4 md:space-x-6">
                    <input type="number" id="n1" placeholder="ä¸Š" class="input-void w-14 md:w-16 text-xl">
                    <input type="number" id="n2" placeholder="ä¸‹" class="input-void w-14 md:w-16 text-xl">
                    <input type="number" id="n3" placeholder="åŠ¨" class="input-void w-14 md:w-16 text-xl">
                </div>
                <div id="input-group-random" class="hidden text-gray-500 font-light text-sm italic">
                    å‡ç¥é™æ°”ï¼Œç‚¹å‡»ä¸‹æ–¹æ„Ÿåº”
                </div>
            </div>

            <div class="relative w-full max-w-xs mx-auto px-4">
                <div class="text-[10px] text-[#d4af37] opacity-60 mb-2 italic tracking-widest">é»˜å¿µé—®é¢˜ 5 æ¬¡</div>
                <input type="text" id="inp-question" placeholder="æ‰€é—®ä½•äº‹..." class="input-void w-full text-base pb-2">
            </div>

            <button onclick="divine(true)" class="btn-spirit px-12 py-3 rounded-full text-sm tracking-[0.3em] uppercase mt-8">
                æ„Ÿ åº”
            </button>
            
            <div class="pt-8 md:pt-12 flex flex-wrap justify-center gap-4 md:gap-6 text-[10px] text-gray-700 items-center">
                <span onclick="toggleTool('xiaoliuren')" class="cursor-pointer hover:text-gray-400 p-2">å°å…­å£¬</span>
                <span class="opacity-30 hidden md:inline">|</span>
                <span onclick="toggleTool('cases')" class="cursor-pointer hover:text-gray-400 p-2">å¤å¦ä¾‹</span>
                <span class="opacity-30 hidden md:inline">|</span>
                <span onclick="toggleTool('history')" class="cursor-pointer hover:text-gray-400 p-2">ğŸ“œ è®°å½•</span>
                <span class="opacity-30 hidden md:inline">|</span>
                <button onclick="toggleColorMode()" id="btn-color-mode" class="cursor-pointer hover:text-[#d4af37] transition-colors flex items-center p-2">
                    ğŸ¨ <span id="color-mode-text" class="ml-1">é»˜è®¤</span>
                </button>
                <span class="opacity-30 hidden md:inline">|</span>
                <span onclick="toggleTool('contrib')" class="cursor-pointer hover:text-gray-400 p-2">ğŸ¤ è´¡çŒ®</span>
            </div>
        </div>

        <!-- åœºæ™¯2ï¼šç»“æœç•Œé¢ -->
        <div id="scene-result" class="hidden w-full fade-in-up flex flex-col items-center">
            
            <div id="capture-area" class="w-full max-w-5xl bg-[#050505] p-6 md:p-12 rounded-xl">
                <div class="text-center mb-8 md:mb-10 opacity-50">
                     <span class="text-[#d4af37] text-sm tracking-[0.5em] border border-[#d4af37] px-2 py-1">ä¹¾å…ƒæ˜“å¦</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 md:gap-20 items-start transition-all duration-300">
                    
                    <!-- å·¦ä¾§ï¼šå¦è±¡ -->
                    <div id="visual-col" class="flex flex-col items-center border-[#222] md:border-r md:pr-10 border-b md:border-b-0 pb-10 md:pb-0 w-full">
                        <div class="text-center mb-8 md:mb-10 space-y-1">
                            <div class="text-gray-500 text-xs font-mono" id="res-gregorian"></div>
                            <div class="text-[#8a7018] text-sm font-bold tracking-widest" id="res-lunar"></div>
                        </div>

                        <div class="flex items-end justify-center space-x-2 md:space-x-8">
                            <!-- ä¸»å¦ -->
                            <div class="gua-col">
                                <span class="text-[10px] text-gray-600 mb-1 tracking-widest">ä¸»Â·å¼€å§‹</span>
                                <div class="text-lg md:text-xl text-[#d4af37] font-bold font-serif" id="fullname-zhu"></div>
                                <div class="text-xs text-gray-600 mb-3" id="name-zhu"></div>
                                <div id="viz-zhu"></div>
                            </div>
                            <!-- äº’å¦ -->
                            <div class="gua-col">
                                <span class="text-[10px] text-gray-600 mb-1 tracking-widest">äº’Â·è¿‡ç¨‹</span>
                                <div class="text-lg md:text-xl text-[#d4af37] font-bold font-serif" id="fullname-hu"></div>
                                <div class="text-xs text-gray-600 mb-3" id="name-hu"></div>
                                <div id="viz-hu"></div>
                            </div>
                            <!-- å˜å¦ -->
                            <div class="gua-col">
                                <span class="text-[10px] text-gray-600 mb-1 tracking-widest">å˜Â·ç»“æœ</span>
                                <div class="text-lg md:text-xl text-[#d4af37] font-bold font-serif" id="fullname-bian"></div>
                                <div class="text-xs text-gray-600 mb-3" id="name-bian"></div>
                                <div id="viz-bian"></div>
                            </div>
                        </div>
                        
                        <!-- å¯ç¼–è¾‘çš„é—®é¢˜è¾“å…¥æ¡† -->
                        <div class="mt-8 md:mt-10 text-center px-2 w-full">
                            <input type="text" id="res-question" class="input-edit text-base md:text-lg" placeholder="ç‚¹å‡»æ­¤å¤„ä¿®æ”¹é—®é¢˜..." onchange="markUnsaved()">
                        </div>

                        <!-- ç¬”è®°/åé¦ˆåŒºåŸŸ (æ–°å¢) -->
                        <div class="mt-6 w-full px-4">
                            <label class="text-[10px] text-[#d4af37] opacity-60 block mb-1">ğŸ“ ç¬”è®° / åé¦ˆ (å¯ç¼–è¾‘)</label>
                            <textarea id="res-feedback" class="textarea-feedback h-24 p-2 rounded" placeholder="åœ¨æ­¤è®°å½•ç»“æœåé¦ˆã€æ–­è¯­æˆ–åç»­åº”éªŒæƒ…å†µ..." onchange="markUnsaved()"></textarea>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šåˆ†æ -->
                    <div id="analysis-col" class="flex flex-col justify-center pt-2 md:pt-0 w-full">
                        <h3 class="text-[#d4af37] text-lg font-light mb-6 flex items-center justify-center md:justify-start">
                            <span class="w-8 h-[1px] bg-[#333] mr-4 md:hidden"></span>
                            æ–­ è¯­
                            <span class="w-8 h-[1px] bg-[#333] ml-4 md:hidden"></span>
                        </h3>
                        <div id="analysis-text" class="text-sm font-light leading-7 md:leading-8 text-gray-300 space-y-4 text-justify px-2 md:px-0"></div>
                        
                        <div class="mt-8 text-center md:text-left flex flex-col gap-3">
                            <button onclick="copyToAI()" class="text-[10px] border border-[#333] hover:border-[#d4af37] text-gray-500 hover:text-[#d4af37] px-4 py-2 rounded transition-colors flex items-center justify-center md:justify-start mx-auto md:mx-0 gap-2 w-full md:w-auto">
                                <span>âœ¨</span> å¤åˆ¶ç»™ AI æ·±åº¦è§£å¦
                            </button>
                            <!-- æ›´æ–°è®°å½•æŒ‰é’® -->
                            <button onclick="updateCurrentRecord()" id="btn-update-record" class="text-[10px] border border-[#333] hover:border-[#d4af37] text-gray-500 hover:text-[#d4af37] px-4 py-2 rounded transition-colors flex items-center justify-center md:justify-start mx-auto md:mx-0 gap-2 w-full md:w-auto">
                                <span>ğŸ’¾</span> æ›´æ–°è®°å½• (ä¿å­˜ä¿®æ”¹)
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-12 text-center text-[10px] text-[#222] uppercase tracking-widest">
                    QianYuan Yi Jing System
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®åŒº -->
            <div class="mt-8 flex space-x-6 pb-8">
                <button onclick="resetApp()" class="btn-spirit px-6 py-2 text-xs rounded-full">å†å ä¸€å¦</button>
                <button onclick="capture()" class="btn-spirit px-6 py-2 text-xs rounded-full flex items-center bg-[#d4af37] text-black border-[#d4af37] hover:bg-[#b5952f] hover:text-black">
                    <span class="mr-2">â–</span> ä¿å­˜å¦è±¡ (æˆªå›¾)
                </button>
            </div>
        </div>
        
        <!-- å¼¹çª—ï¼šå°å…­å£¬ -->
        <div id="modal-xiaoliuren" class="fixed inset-0 bg-black/95 z-40 hidden flex items-center justify-center backdrop-blur-sm px-4">
            <div class="modal-content relative">
                <button onclick="toggleTool('xiaoliuren')" class="absolute top-4 right-4 text-gray-600 hover:text-white p-2">âœ•</button>
                <h3 class="text-[#d4af37] mb-8 tracking-widest text-center">å°å…­å£¬é€Ÿæ–­</h3>
                <div class="flex justify-center space-x-2 md:space-x-4 mb-8">
                    <input type="number" id="xlr1" placeholder="æ•°1" class="input-void w-14 md:w-16 text-lg">
                    <input type="number" id="xlr2" placeholder="æ•°2" class="input-void w-14 md:w-16 text-lg">
                    <input type="number" id="xlr3" placeholder="æ•°3" class="input-void w-14 md:w-16 text-lg">
                </div>
                <div class="flex justify-center space-x-4 mb-8">
                    <button onclick="calcXLR()" class="btn-spirit px-6 py-2 text-xs rounded">æ¨ æ¼”</button>
                    <button onclick="xlrToDivination()" class="btn-spirit px-6 py-2 text-xs rounded border-dashed border-gray-600 hover:border-[#d4af37]">è½¬æ’æ¢…èŠ± â</button>
                </div>
                <div id="xlr-res" class="grid grid-cols-3 gap-2 md:gap-4 text-sm hidden bg-[#111] p-4 rounded text-center">
                     <div><div class="text-gray-600 text-[10px] mb-1">åˆ</div><div id="xr1"></div></div>
                     <div><div class="text-gray-600 text-[10px] mb-1">ä¸­</div><div id="xr2"></div></div>
                     <div><div class="text-gray-600 text-[10px] mb-1">ç»ˆ</div><div id="xr3"></div></div>
                </div>
            </div>
        </div>

        <!-- è´¡çŒ® -->
        <div id="modal-contrib" class="fixed inset-0 bg-black/95 z-40 hidden flex items-center justify-center backdrop-blur-sm px-4">
            <div class="modal-content relative text-center">
                <button onclick="toggleTool('contrib')" class="absolute top-4 right-4 text-gray-600 hover:text-white p-2">âœ•</button>
                <h3 class="text-[#d4af37] mb-6 tracking-widest">è´¡ çŒ® ä¸ å é¦ˆ</h3>
                <div class="text-gray-400 text-xs leading-6 mb-6">
                    <p>æ„Ÿè°¢ç¬¬ä¸€æ‰¹å†…æµ‹ç”¨æˆ·çš„å®è´µå»ºè®®ã€‚</p>
                    <p>åç»­å°†åœ¨æ­¤å¤„å±•ç¤ºä¼˜ç§€åé¦ˆä¸å¼€æºè´¡çŒ®è€…ã€‚</p>
                </div>
                <div class="border border-[#222] bg-[#111] p-4 rounded text-left text-[10px] text-gray-500 space-y-2">
                    <p>Â· æ ¸å¿ƒç®—æ³•åŒæ­¥ Python (Done)</p>
                    <p>Â· 64å¦åæ˜¾ç¤º (Done)</p>
                    <p>Â· æ—ºç›¸ä¼‘å›šæ­»é€»è¾‘ (Done)</p>
                    <p>Â· AI é—®ç­–æ¥å£ (Done)</p>
                    <p>Â· è®°å½•ç¼–è¾‘ä¸åé¦ˆ (Done)</p>
                </div>
            </div>
        </div>

        <!-- å¦ä¾‹ -->
        <div id="modal-cases" class="fixed inset-0 bg-black/95 z-40 hidden flex items-center justify-center backdrop-blur-sm px-4">
            <div class="modal-content relative">
                <button onclick="toggleTool('cases')" class="absolute top-4 right-4 text-gray-600 hover:text-white p-2">âœ•</button>
                <h3 class="text-[#d4af37] mb-8 text-center tracking-widest">å¤ ç± å¦ ä¾‹</h3>
                <div class="space-y-3 mb-8">
                    <div onclick="loadCase(0)" class="p-4 border border-[#222] hover:border-[#d4af37] cursor-pointer text-sm text-gray-400 hover:text-white transition-colors rounded">è§‚æ¢…å  (é‚µåº·èŠ‚)</div>
                    <div onclick="loadCase(1)" class="p-4 border border-[#222] hover:border-[#d4af37] cursor-pointer text-sm text-gray-400 hover:text-white transition-colors rounded">é‚»å¤œæ‰£é—¨å€Ÿç‰©å </div>
                </div>
                <div id="case-content" class="hidden text-sm font-light text-gray-300 leading-7 bg-[#111] p-6 rounded border-l-2 border-[#d4af37]">
                    <p id="c-time" class="text-[#8a7018] text-xs mb-2"></p>
                    <p id="c-qs" class="font-bold mb-4 text-white"></p>
                    <p id="c-fk" class="opacity-80 italic"></p>
                    <!-- è°ƒæ•´é€»è¾‘ï¼šç‚¹å‡»æ’ç›˜æŸ¥çœ‹ï¼Œä¸è‡ªåŠ¨ä¿å­˜ï¼Œä½†è¿›å…¥ç•Œé¢åå¯ä»¥ç‚¹å‡»ä¿å­˜æŒ‰é’®æ‰‹åŠ¨å­˜ -->
                    <button onclick="caseToDivination()" class="mt-4 text-[10px] text-[#d4af37] underline block w-full text-right">æ’ç›˜æŸ¥çœ‹</button>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½• -->
        <div id="modal-history" class="fixed inset-0 bg-black/95 z-40 hidden flex items-center justify-center backdrop-blur-sm px-4">
            <div class="modal-content relative max-h-[70vh] flex flex-col">
                <button onclick="toggleTool('history')" class="absolute top-4 right-4 text-gray-600 hover:text-white p-2">âœ•</button>
                <h3 class="text-[#d4af37] mb-6 text-center tracking-widest">æœ¬ åœ° è®° å½•</h3>
                <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="history-list"></div>
                <div class="mt-4 text-center pt-2 border-t border-[#222]">
                    <button onclick="clearHistory()" class="text-[10px] text-red-500 hover:underline p-2">æ¸…ç©ºæ‰€æœ‰</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- æ•°æ® ---
        const GUA_64 = {
            "ä¹¾ä¹¾": "ä¹¾ä¸ºå¤©", "å¤å¤": "å¤ä¸ºåœ°", "å…‘å…‘": "å…‘ä¸ºæ³½", "ç¦»ç¦»": "ç¦»ä¸ºç«", 
            "éœ‡éœ‡": "éœ‡ä¸ºé›·", "å·½å·½": "å·½ä¸ºé£", "åå": "åä¸ºæ°´", "è‰®è‰®": "è‰®ä¸ºå±±",
            "ä¹¾å": "å¤©æ°´è®¼", "ä¹¾ç¦»": "å¤©ç«åŒäºº", "ä¹¾éœ‡": "å¤©é›·æ— å¦„", "ä¹¾å·½": "å¤©é£å§¤", 
            "ä¹¾è‰®": "å¤©å±±é", "ä¹¾å…‘": "å¤©æ³½å±¥", "ä¹¾å¤": "å¤©åœ°å¦", "å…‘å": "æ³½æ°´å›°", 
            "å…‘è‰®": "æ³½å±±å’¸", "å…‘ç¦»": "æ³½ç«é©", "å…‘ä¹¾": "æ³½å¤©å¤¬", "å…‘å·½": "æ³½é£å¤§è¿‡", 
            "å…‘éœ‡": "æ³½é›·éš", "å…‘å¤": "æ³½åœ°èƒ", "ç¦»ä¹¾": "ç«å¤©å¤§æœ‰", "ç¦»å¤": "ç«åœ°æ™‹", 
            "ç¦»å·½": "ç«é£é¼", "ç¦»è‰®": "ç«å±±æ—…", "ç¦»å": "ç«æ°´æœªæµ", "ç¦»å…‘": "ç«æ³½ç½", 
            "ç¦»éœ‡": "ç«é›·å™¬å—‘", "éœ‡ä¹¾": "é›·å¤©å¤§å£®", "éœ‡å¤": "é›·åœ°è±«", "éœ‡å…‘": "é›·æ³½å½’å¦¹", 
            "éœ‡ç¦»": "é›·ç«ä¸°", "éœ‡å·½": "é›·é£æ’", "éœ‡è‰®": "é›·å±±å°è¿‡", "éœ‡å": "é›·æ°´è§£", 
            "å·½ä¹¾": "é£å¤©å°ç•œ", "å·½å¤": "é£åœ°è§‚", "å·½å…‘": "é£æ³½ä¸­å­š", "å·½ç¦»": "é£ç«å®¶äºº", 
            "å·½éœ‡": "é£é›·ç›Š", "å·½å": "é£æ°´æ¶£", "å·½è‰®": "é£å±±æ¸", "åä¹¾": "æ°´å¤©éœ€", 
            "åå¤": "æ°´åœ°æ¯”", "åå…‘": "æ°´æ³½èŠ‚", "åç¦»": "æ°´ç«æ—¢æµ", "åéœ‡": "æ°´é›·å±¯", 
            "åå·½": "æ°´é£äº•", "åè‰®": "æ°´å±±è¹‡", "è‰®éœ‡": "å±±é›·é¢", "è‰®å·½": "å±±é£è›Š", 
            "è‰®ä¹¾": "å±±å¤©å¤§ç•œ", "è‰®å¤": "å±±åœ°å‰¥", "è‰®å…‘": "å±±æ³½æŸ", "è‰®ç¦»": "å±±ç«è´²", 
            "è‰®å": "å±±æ°´è’™", "å¤ç¦»": "åœ°ç«æ˜å¤·", "å¤å": "åœ°æ°´å¸ˆ", "å¤å…‘": "åœ°æ³½ä¸´", 
            "å¤å·½": "åœ°é£å‡", "å¤éœ‡": "åœ°é›·å¤", "å¤è‰®": "åœ°å±±è°¦", "å¤ä¹¾": "åœ°å¤©æ³°"
        };

        const GUA = {
            '111': { n: "ä¹¾", w: "é‡‘" }, '011': { n: "å…‘", w: "é‡‘" },
            '101': { n: "ç¦»", w: "ç«" }, '001': { n: "éœ‡", w: "æœ¨" },
            '110': { n: "å·½", w: "æœ¨" }, '010': { n: "å", w: "æ°´" },
            '100': { n: "è‰®", w: "åœŸ" }, '000': { n: "å¤", w: "åœŸ" }
        };
        const XT_SEQ = ['111', '011', '101', '001', '110', '010', '100', '000']; 
        const DZ = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
        const WX = ["é‡‘","æ°´","æœ¨","ç«","åœŸ"];
        const COLOR_MAP = {
            "é‡‘": "color-jin", "æœ¨": "color-mu", "æ°´": "color-shui", "ç«": "color-huo", "åœŸ": "color-tu"
        };

        let appState = { 
            mode: 'time', 
            colorMode: localStorage.getItem('qy_color_mode') || 'gold',
            currentRecordId: null, // å½“å‰è®°å½•çš„ID (æ—¶é—´æˆ³)
            currentNums: null // å½“å‰å¦çš„æ•°å­—
        };

        const caseDB = [
            {t:"è¾°å¹´ åäºŒæœˆåä¸ƒæ—¥ ç”³æ—¶", q:"è§‚æ¢…å ", g:[30,39,39], f:"è§äºŒé›€äº‰æå åœ°ã€‚é¢„è¨€ï¼šæ˜æ™šå½“æœ‰å¥³å­æŠ˜èŠ±ï¼Œå›­ä¸ä¸çŸ¥è€Œé€ä¹‹ï¼Œå¥³å­å¤±æƒŠå åœ°ï¼Œé€ä¼¤å…¶è‚¡ã€‚åæœå¦‚éªŒã€‚"},
            {t:"å†¬æœˆ åä¸ƒæ—¥ é…‰æ—¶", q:"æ‰£é—¨å€Ÿç‰©", g:[1,6,6], f:"é—»æ‰£é—¨å£°ï¼Œåˆä¸€å£°ï¼Œæ­¢ï¼Œç»§è€Œåˆäº”å£°ã€‚ä¸”äº‘å€Ÿç‰©ã€‚æ–­æ›°ï¼šå€Ÿæ–§ã€‚æœå€Ÿæ–§ã€‚"}
        ];

        window.onload = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            document.getElementById('inp-time').value = (new Date(now - offset)).toISOString().slice(0, 16);
            updateColorBtnText();
        };

        // --- æ ¸å¿ƒç®—æ³• ---
        function calculate(a, b, c) {
            if (a === 0) a = 8; if (b === 0) b = 8; if (c === 0) c = 6;
            let idxA = (a % 8 === 0) ? 7 : (a % 8) - 1;
            let idxB = (b % 8 === 0) ? 7 : (b % 8) - 1;
            let mv = (c % 6 === 0) ? 6 : (c % 6);
            let zT = XT_SEQ[idxA], zB = XT_SEQ[idxB];
            let hT = zT[1] + zT[2] + zB[0], hB = zT[2] + zB[0] + zB[1];
            let full = (zT + zB).split('');
            let flipIdx = 6 - mv;
            full[flipIdx] = full[flipIdx] === '1' ? '0' : '1';
            return { z: [zT, zB], h: [hT, hB], b: [full.slice(0,3).join(''), full.slice(3,6).join('')], mv: mv };
        }

        function drawGua(id, top, bot, moveLine = -1) {
            const el = document.getElementById(id);
            el.innerHTML = ''; el.className = 'gua-grid';
            const topW = GUA[top].w; const botW = GUA[bot].w;
            const bits = top + bot;
            for (let i = 0; i < 6; i++) {
                const isYang = bits[i] === '1';
                const row = document.createElement('div');
                row.className = `gua-row ${isYang ? 'yang-line' : 'yin-line'}`;
                let colorClass = '';
                if (appState.colorMode === 'wuxing') {
                    colorClass = (i < 3) ? COLOR_MAP[topW] : COLOR_MAP[botW];
                }
                const createBar = () => {
                    const b = document.createElement('div'); b.className = 'bar ' + colorClass; return b;
                }
                if (isYang) row.appendChild(createBar());
                else { row.appendChild(createBar()); row.appendChild(createBar()); }
                if (moveLine !== -1 && i === (6 - moveLine)) {
                    const dot = document.createElement('div'); dot.className = 'moving-dot'; row.appendChild(dot);
                }
                el.appendChild(row);
            }
        }

        function divine(saveToHistory = true, existingId = null, feedbackVal = "") {
            let a, b, c, gregStr, lunarStr, monthIdx;
            let qs = document.getElementById('inp-question').value || "æ— é—®è‡ªå ";

            // å¦‚æœæ˜¯ä»å†å²åŠ è½½ï¼Œä½¿ç”¨ä¼ å…¥çš„æ•°å­—ï¼Œå¦åˆ™è¯»å–è¾“å…¥
            if (appState.mode === 'number' || existingId) {
                // å¦‚æœæ˜¯ loadHistoryItem è°ƒç”¨çš„ï¼Œæ­¤æ—¶ n1,n2,n3 å·²ç»è¢«è®¾ç½®å¥½äº†
                a = +document.getElementById('n1').value; 
                b = +document.getElementById('n2').value; 
                c = +document.getElementById('n3').value;
                gregStr = existingId ? "å†å²è®°å½•" : "æ•°å­—èµ·å¦"; 
                lunarStr = `[${a}, ${b}, ${c}]`; 
                monthIdx = new Date().getMonth(); 
            } else if (appState.mode === 'random') {
                a = Math.floor(Math.random()*64)+1; b = Math.floor(Math.random()*64)+1; c = Math.floor(Math.random()*6)+1;
                gregStr = "éšæœºèµ·å¦"; lunarStr = "çµæœºä¸€åŠ¨"; monthIdx = new Date().getMonth(); 
            } else { // time
                const d = new Date(document.getElementById('inp-time').value);
                const l = Lunar.fromDate(d);
                const yI = DZ.indexOf(l.getYearZhi()) + 1;
                const m = l.getMonth(); const day = l.getDay();
                let h = d.getHours();
                let hI = Math.floor((h + 1) / 2) + 1;
                a = yI + m + day; b = a + hI; c = b;
                gregStr = `å…¬å†: ${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                let hourChar = (h >= 23 || h < 1) ? "å­" : DZ[Math.floor((h + 1) / 2) % 12];
                lunarStr = `å†œå†: ${l.getYearInGanZhi()}å¹´ ${l.getMonthInChinese()}æœˆ${l.getDayInChinese()} ${hourChar}æ—¶`;
                monthIdx = m - 1; 
            }

            if (!a || !b || !c) {
                if(!existingId) return alert("æ•°æ®é”™è¯¯");
            }

            const res = calculate(a, b, c);
            
            // çŠ¶æ€ç®¡ç†ï¼šç¡®å®šå½“å‰çš„ ID
            if (existingId) {
                appState.currentRecordId = existingId;
            } else if (saveToHistory && qs !== "æ— é—®è‡ªå ") {
                // æ–°çš„å åœï¼Œä¸”éœ€è¦ä¿å­˜
                const newId = Date.now();
                saveHistory({ t: newId, n: [a, b, c], q: qs, fb: "" }); // åˆå§‹åé¦ˆä¸ºç©º
                appState.currentRecordId = newId;
            } else {
                // ä¸ä¿å­˜ï¼ˆå¦‚å¤ä¾‹æµè§ˆï¼Œæˆ–è€…æ²¡å†™é—®é¢˜ï¼‰ï¼Œä½†ä¹Ÿç”Ÿæˆä¸€ä¸ªä¸´æ—¶IDä¾›åç»­æ‰‹åŠ¨ä¿å­˜
                appState.currentRecordId = Date.now(); 
                // æ­¤æ—¶ä¸å†™å…¥ localStorage
            }
            
            appState.currentNums = [a, b, c];

            // UI åˆ‡æ¢
            document.getElementById('main-header').style.opacity = '0';
            document.getElementById('main-header').style.pointerEvents = 'none';
            const inputScene = document.getElementById('scene-input');
            inputScene.classList.add('fade-out');
            setTimeout(() => {
                inputScene.classList.add('hidden');
                inputScene.classList.remove('fade-out');
                document.getElementById('scene-result').classList.remove('hidden');
            }, 700);

            document.getElementById('res-gregorian').innerText = gregStr;
            document.getElementById('res-lunar').innerText = lunarStr;
            
            // å¡«å……å¯ç¼–è¾‘åŒºåŸŸ
            document.getElementById('res-question').value = qs;
            document.getElementById('res-feedback').value = feedbackVal;

            // 64å¦å
            const getName = (t, b) => GUA_64[GUA[t].n + GUA[b].n] || "æœªçŸ¥";
            document.getElementById('fullname-zhu').innerText = getName(res.z[0], res.z[1]);
            document.getElementById('name-zhu').innerText = GUA[res.z[0]].n + GUA[res.z[1]].n;
            drawGua('viz-zhu', res.z[0], res.z[1], res.mv);
            document.getElementById('fullname-hu').innerText = getName(res.h[0], res.h[1]);
            document.getElementById('name-hu').innerText = GUA[res.h[0]].n + GUA[res.h[1]].n;
            drawGua('viz-hu', res.h[0], res.h[1]);
            document.getElementById('fullname-bian').innerText = getName(res.b[0], res.b[1]);
            document.getElementById('name-bian').innerText = GUA[res.b[0]].n + GUA[res.b[1]].n;
            drawGua('viz-bian', res.b[0], res.b[1]);

            analyzeLogic(res, monthIdx);
        }

        // --- æ—ºè¡°ä¸æ–­å¦ ---
        function getSeasonState(wuxing, month) {
            const m = month + 1;
            let season = "";
            if([1,2].includes(m)) season = "æœ¨"; else if([4,5].includes(m)) season = "ç«"; else if([7,8].includes(m)) season = "é‡‘"; else if([10,11].includes(m)) season = "æ°´"; else season = "åœŸ";
            if(wuxing === season) return "æ—º (å¾—ä»¤)"; return wuxing === season ? "æ—º" : "è¡°";
        }

        function analyzeLogic(res, monthIdx) {
            const getRel = (t, y) => {
                const ti = WX.indexOf(t), yi = WX.indexOf(y);
                const n = (i, off) => WX[(i+off)%5];
                if (n(ti,1)===y) return {s:2, t:"ä½“ç”Ÿç”¨Â·æ³„æ°”"}; if (n(ti,2)===y) return {s:3, t:"ä½“å…‹ç”¨Â·è¿›è´¢"}; if (n(ti,3)===y) return {s:1, t:"ç”¨å…‹ä½“Â·å—åˆ¶"}; if (n(ti,4)===y) return {s:4, t:"ç”¨ç”Ÿä½“Â·å¾—åŠ©"}; return {s:3, t:"æ¯”å’ŒÂ·é¡ºé‚"};
            };
            let tiG, yongG;
            if (res.mv <= 3) { tiG = res.z[0]; yongG = res.z[1]; } else { tiG = res.z[1]; yongG = res.z[0]; }
            const tiW = GUA[tiG].w; const zhuYongW = GUA[yongG].w;
            const seasonState = getSeasonState(tiW, monthIdx);
            
            // å­˜å…¥ window å¯¹è±¡ä¾›AIä½¿ç”¨ (ä¸´æ—¶)
            window.lastAiData = { tiW, yongW: zhuYongW, seasonState, res, qs: document.getElementById('res-question').value };

            let huTiW, huYongW, bianTiW, bianYongW;
            if (res.mv <= 3) { huTiW = GUA[res.h[0]].w; huYongW = GUA[res.h[1]].w; bianTiW = GUA[res.b[0]].w; bianYongW = GUA[res.b[1]].w; } 
            else { huTiW = GUA[res.h[1]].w; huYongW = GUA[res.h[0]].w; bianTiW = GUA[res.b[1]].w; bianYongW = GUA[res.b[0]].w; }
            const r1 = getRel(tiW, zhuYongW); const r2 = getRel(huTiW, huYongW); const r3 = getRel(bianTiW, bianYongW);
            window.lastAiData.rels = [r1, r2, r3];

            let html = `
                <div class="border-l-2 border-[#d4af37] pl-4 mb-6">
                    <p>ä½“å¦ <span class="mark-gold font-bold text-lg">${tiW}</span> (${seasonState})</p>
                    <p class="text-xs text-gray-500 mt-1">ä½“å¦ä¸ºä¸»ï¼Œç”¨å¦ä¸ºäº‹ã€‚</p>
                </div>
                <div class="grid grid-cols-1 gap-3 text-gray-400 mb-8">
                    <div class="flex justify-between border-b border-[#222] pb-2"><span>ã€å§‹ã€‘ä¸»å¦</span><span>${r1.t}</span></div>
                    <div class="flex justify-between border-b border-[#222] pb-2"><span>ã€å†ã€‘äº’å¦</span><span>${r2.t}</span></div>
                    <div class="flex justify-between border-b border-[#222] pb-2"><span>ã€ç»ˆã€‘å˜å¦</span><span>${r3.t}</span></div>
                </div>
                <div class="space-y-4 font-normal text-gray-300">
            `;
            if (r1.s > r3.s) html += `<p class="mark-bad">âš ï¸ å˜æ¯”ä¸»å‡¶ï¼Œäº‹å¤šé˜»ç¢ã€‚</p>`; else if (r1.s < r3.s) html += `<p class="mark-good">âœ… å˜æ¯”ä¸»å‰ï¼Œæ¸å…¥ä½³å¢ƒã€‚</p>`; else html += `<p class="mark-gold">âš–ï¸ å‰å‡¶æ— å¤§å˜ï¼Œå¹³ç¨³å‘å±•ã€‚</p>`;
            const trend = (s1, s2) => s2 > s1 ? "ä¸Šå‡" : (s2 < s1 ? "ä¸‹æ»‘" : "å¹³ç¨³");
            html += `<p class="text-xs text-gray-500 leading-6">äº‹æƒ…åˆå§‹${r1.s<=2?'è¾ƒä¸ºè‰°éš¾':'è¾ƒä¸ºé¡ºåˆ©'}ï¼Œè¿‡ç¨‹ä¸­è¿åŠ¿${trend(r1.s,r2.s)}ï¼Œæœ€ç»ˆç»“å±€${r3.s>r2.s?'ä¼˜äº':'ä¸å¦‚'}è¿‡ç¨‹ã€‚</p>`;
            if (Math.abs(r1.s - r3.s) > 2) html += `<p class="text-xs text-[#d4af37] mt-2">æ³¨ï¼šå¦è±¡å˜åŒ–å‰§çƒˆã€‚</p>`;
            html += `</div>`;
            document.getElementById('analysis-text').innerHTML = html;
        }

        // --- å†å²è®°å½•ç®¡ç† (å¢åˆ æ”¹) ---
        
        // ä¿å­˜ä¸€æ¡æ–°è®°å½•ï¼ˆæˆ–è¦†ç›–ï¼‰
        function saveHistory(item) {
            let hist = JSON.parse(localStorage.getItem('qy_history') || '[]');
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨
            const idx = hist.findIndex(h => h.t === item.t);
            if (idx >= 0) {
                hist[idx] = item; // æ›´æ–°
            } else {
                hist.unshift(item); // æ–°å¢
                if (hist.length > 50) hist.pop();
            }
            localStorage.setItem('qy_history', JSON.stringify(hist));
        }

        // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„è®°å½•
        function updateCurrentRecord() {
            if (!appState.currentRecordId || !appState.currentNums) return;
            
            const newQs = document.getElementById('res-question').value;
            const newFb = document.getElementById('res-feedback').value;
            
            const record = {
                t: appState.currentRecordId,
                n: appState.currentNums,
                q: newQs,
                fb: newFb
            };
            
            saveHistory(record);
            
            // è§†è§‰åé¦ˆ
            const btn = document.getElementById('btn-update-record');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="text-[#a7f3d0]">âœ… å·²ä¿å­˜</span>`;
            setTimeout(() => { btn.innerHTML = originalText; }, 1500);
        }

        function renderHistory() {
            const hist = JSON.parse(localStorage.getItem('qy_history') || '[]');
            const con = document.getElementById('history-list');
            con.innerHTML = '';
            if (hist.length === 0) { con.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">æš‚æ— è®°å½•</div>'; return; }
            hist.forEach((h, index) => {
                const d = new Date(h.t);
                const dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = "group relative p-3 border border-[#222] hover:border-[#d4af37] rounded bg-[#111] transition-colors flex justify-between items-center";
                
                const contentDiv = document.createElement('div');
                contentDiv.className = "flex-1 cursor-pointer";
                // ä¼ é€’åé¦ˆä¿¡æ¯
                contentDiv.onclick = () => loadHistoryItem(h.n, h.q, h.t, h.fb || "");
                contentDiv.innerHTML = `
                    <div class="flex justify-between text-[#8a7018] text-[10px] mb-1 pr-2">
                        <span>${dateStr}</span>
                        <span>[${h.n.join(',')}]</span>
                    </div>
                    <div class="text-gray-300 text-sm truncate pr-2">${h.q}</div>
                `;

                const delBtn = document.createElement('div');
                delBtn.className = "text-gray-600 hover:text-red-500 cursor-pointer px-2 text-lg md:opacity-0 md:group-hover:opacity-100 transition-opacity"; 
                delBtn.innerHTML = "&times;";
                delBtn.onclick = (e) => { e.stopPropagation(); deleteHistoryItem(index); };
                itemDiv.appendChild(contentDiv); itemDiv.appendChild(delBtn); con.appendChild(itemDiv);
            });
        }

        function deleteHistoryItem(index) {
            if(confirm('åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) {
                let hist = JSON.parse(localStorage.getItem('qy_history') || '[]');
                hist.splice(index, 1); localStorage.setItem('qy_history', JSON.stringify(hist)); renderHistory();
            }
        }

        function loadHistoryItem(nums, qs, id, fb) {
            setMode('number'); 
            document.getElementById('n1').value = nums[0]; 
            document.getElementById('n2').value = nums[1]; 
            document.getElementById('n3').value = nums[2];
            document.getElementById('inp-question').value = qs; 
            toggleTool('history'); 
            // å…³é”®ï¼šä¼ å…¥ ID å’Œ åé¦ˆå†…å®¹
            divine(false, id, fb);
        }

        function clearHistory() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) { localStorage.removeItem('qy_history'); renderHistory(); }
        }

        function markUnsaved() {
            // å¯ä»¥åœ¨è¿™é‡Œæ”¹å˜æŒ‰é’®é¢œè‰²æç¤ºæœªä¿å­˜ï¼Œç®€åŒ–ç‰ˆæš‚ä¸å®ç°
        }

        // --- é€šç”¨ ---
        function copyToAI() {
            const d = window.lastAiData;
            if(!d) return;
            const prompt = `æˆ‘ç”¨æ¢…èŠ±æ˜“æ•°å åœäº†ä¸€å¦ï¼Œè¯·å¤§å¸ˆå¸®æˆ‘è¯¦ç»†è§£æã€‚
1. **èµ·å¦æ—¶é—´**ï¼š${document.getElementById('res-lunar').innerText}
2. **å é—®äº‹é¡¹**ï¼š${d.qs}
3. **å¦è±¡ä¿¡æ¯**ï¼š
   - **ä¸»å¦**ï¼š${document.getElementById('fullname-zhu').innerText} (ä½“:${d.tiW}[${d.seasonState}], ç”¨:${d.yongW})
   - **äº’å¦**ï¼š${document.getElementById('fullname-hu').innerText}
   - **å˜å¦**ï¼š${document.getElementById('fullname-bian').innerText}
   - **åŠ¨çˆ»**ï¼š${d.res.mv}çˆ»åŠ¨
4. **ç”Ÿå…‹å…³ç³»**ï¼š
   - å¼€å§‹ï¼š${d.rels[0].t}
   - è¿‡ç¨‹ï¼š${d.rels[1].t}
   - ç»“æœï¼š${d.rels[2].t}
5. **ç”¨æˆ·åé¦ˆ/ç¬”è®°**ï¼š${document.getElementById('res-feedback').value}

è¯·ç»“åˆäº”è¡Œæ—ºè¡°ã€ä½“ç”¨ç”Ÿå…‹ã€å¦è±¡å«ä¹‰ï¼Œç»™æˆ‘ä¸€ç¯‡è¯¦ç»†çš„æ–­è¯­ã€‚`;
            navigator.clipboard.writeText(prompt).then(() => { alert("å·²å¤åˆ¶è¯¦ç»†æç¤ºè¯ï¼\nè¯·ç²˜è´´ç»™ ChatGPT / DeepSeek / Claudeã€‚"); });
        }

        function capture() {
            // æˆªå›¾å‰å¼ºåˆ¶ä¿å­˜ä¸€æ¬¡
            updateCurrentRecord();
            const target = document.getElementById('capture-area');
            const originalBtnText = event.target.innerHTML;
            event.target.innerText = "ç”Ÿæˆä¸­...";
            html2canvas(target, {
                backgroundColor: "#050505", scale: 2, useCORS: true,
                onclone: (clonedDoc) => {
                    const analysisCol = clonedDoc.getElementById('analysis-col'); if (analysisCol) analysisCol.style.display = 'none';
                    const visualCol = clonedDoc.getElementById('visual-col');
                    if (visualCol) { visualCol.style.borderRight = 'none'; visualCol.style.paddingRight = '0'; visualCol.style.paddingBottom = '0'; }
                    const gridContainer = visualCol.parentElement;
                    if (gridContainer) { gridContainer.classList.remove('md:grid-cols-2'); gridContainer.classList.add('flex', 'justify-center'); }
                    
                    // ç¡®ä¿è¾“å…¥æ¡†å†…å®¹åœ¨æˆªå›¾ä¸­å¯è§ (input value -> div text)
                    const qInput = clonedDoc.getElementById('res-question');
                    const qDiv = clonedDoc.createElement('div');
                    qDiv.className = "text-gray-300 text-base font-serif italic text-center";
                    qDiv.innerText = document.getElementById('res-question').value;
                    qInput.parentNode.replaceChild(qDiv, qInput);

                    // ç¡®ä¿Textareaå†…å®¹å¯è§
                    const fbInput = clonedDoc.getElementById('res-feedback');
                    const fbDiv = clonedDoc.createElement('div');
                    fbDiv.className = "text-gray-500 text-xs mt-2 border-t border-[#222] pt-2 whitespace-pre-wrap text-left";
                    fbDiv.innerText = document.getElementById('res-feedback').value ? "ğŸ“ " + document.getElementById('res-feedback').value : "";
                    fbInput.parentNode.replaceChild(fbDiv, fbInput);
                }
            }).then(canvas => {
                const link = document.createElement('a'); link.download = `ä¹¾å…ƒæ˜“å¦_${new Date().getTime()}.png`; link.href = canvas.toDataURL("image/png"); link.click(); event.target.innerHTML = originalBtnText;
            });
        }

        // --- å°å…­å£¬ & æ¡ˆä¾‹ ---
        function calcXLR() {
            let n1=+document.getElementById('xlr1').value, n2=+document.getElementById('xlr2').value, n3=+document.getElementById('xlr3').value;
            if(!n1) return;
            // ä¿®å¤é…è‰²ï¼šå¤§å®‰ä¸ºç»¿
            const XLR_MAP = [{t:"å¤§å®‰Â·æœ¨", c:"text-[#4ade80]"}, {t:"ç•™è¿Â·åœŸ", c:"text-[#d97706]"}, {t:"é€Ÿå–œÂ·ç«", c:"text-[#f87171]"}, {t:"èµ¤å£Â·é‡‘", c:"text-[#d4af37]"}, {t:"å°å‰Â·æ°´", c:"text-[#60a5fa]"}, {t:"ç©ºäº¡Â·åœŸ", c:"text-[#d97706]"}];
            let i1 = (n1-1)%6; if(i1<0)i1+=6; let i2 = (i1+n2-1)%6; if(i2<0)i2+=6; let i3 = (i2+n3-1)%6; if(i3<0)i3+=6;
            document.getElementById('xlr-res').classList.remove('hidden');
            document.getElementById('xr1').className = XLR_MAP[i1].c + " font-bold text-lg"; document.getElementById('xr1').innerText = XLR_MAP[i1].t;
            document.getElementById('xr2').className = XLR_MAP[i2].c + " font-bold text-lg"; document.getElementById('xr2').innerText = XLR_MAP[i2].t;
            document.getElementById('xr3').className = XLR_MAP[i3].c + " font-bold text-lg"; document.getElementById('xr3').innerText = XLR_MAP[i3].t;
        }
        function xlrToDivination() {
            let n1 = document.getElementById('xlr1').value; let n2 = document.getElementById('xlr2').value; let n3 = document.getElementById('xlr3').value;
            if(!n1 || !n2 || !n3) return alert("è¯·å…ˆå¡«å†™ä¸‰ä¸ªæ•°å­—");
            setMode('number'); document.getElementById('n1').value = n1; document.getElementById('n2').value = n2; document.getElementById('n3').value = n3;
            toggleTool('xiaoliuren'); divine();
        }
        function loadCase(idx) {
            const c = caseDB[idx];
            document.getElementById('case-content').classList.remove('hidden');
            document.getElementById('c-time').innerText = c.t; document.getElementById('c-qs').innerText = c.q; document.getElementById('c-fk').innerText = c.f;
            document.getElementById('case-content').dataset.g = JSON.stringify(c.g);
        }
        function caseToDivination() {
            const g = JSON.parse(document.getElementById('case-content').dataset.g);
            setMode('number'); toggleTool('cases');
            document.getElementById('n1').value = g[0]; document.getElementById('n2').value = g[1]; document.getElementById('n3').value = g[2];
            document.getElementById('inp-question').value = document.getElementById('c-qs').innerText;
            // æ¡ˆä¾‹ä¸è‡ªåŠ¨å­˜å†å²ï¼Œé˜²æ­¢æ±¡æŸ“ï¼Œä½†è¿›å…¥åå¯æ‰‹åŠ¨ç‚¹æ›´æ–°æŒ‰é’®å­˜
            divine(false, null, document.getElementById('c-fk').innerText);
        }
        
        // --- è¾…åŠ© ---
        function toggleTool(id) {
            const el = document.getElementById('modal-' + id);
            el.classList.toggle('hidden');
            if (id === 'history' && !el.classList.contains('hidden')) renderHistory();
        }
        function setMode(m) {
            appState.mode = m;
            ['time', 'number', 'random'].forEach(x => {
                document.getElementById('btn-mode-' + x).classList.toggle('text-[#d4af37]', x === m);
                document.getElementById('input-group-' + x).classList.toggle('hidden', x !== m);
            });
        }
        function resetApp() {
            document.getElementById('scene-result').classList.add('hidden');
            document.getElementById('scene-input').classList.remove('hidden');
            document.getElementById('inp-question').value = '';
            document.getElementById('main-header').style.opacity = '1';
            document.getElementById('n1').value = ''; document.getElementById('n2').value = ''; document.getElementById('n3').value = '';
            appState.currentRecordId = null;
        }
        function toggleColorMode() {
            appState.colorMode = (appState.colorMode === 'gold') ? 'wuxing' : 'gold';
            localStorage.setItem('qy_color_mode', appState.colorMode);
            updateColorBtnText();
        }
        function updateColorBtnText() { document.getElementById('color-mode-text').innerText = (appState.colorMode === 'gold') ? 'é»˜è®¤' : 'äº”è¡Œ'; }
    </script>
</body>
</html>
